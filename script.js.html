<script>
var sheet
function openMenu() {
    document.querySelector('.nav-menu').classList.toggle("active");
    document.querySelector('.menu-cont').classList.toggle("active");
    if (window.innerWidth > 668) {
      if (document.querySelector('.menu-cont').contains('active')) { // inactive menu
        document.getElementById('main').style.setProperty('width', '100%')
      } else { // active menu
        document.getElementById('main').style.setProperty('width', 'calc(100% - 130px)')
      }
    } else {document.getElementById('main').style.setProperty('width', '100%')}
}

function toggleDisplay(elmStrIn) { let elm = $('#'+elmStrIn)
  if (elm.css('display') == "none") { elm.css('display', 'block') }  else  { elm.css('display', 'none') }
}

/*
function update() {
  google.script.run.withSuccessHandler(function() {
    if (!(document.getElementById('updateLoad').style.display === "none")) {
      toggleDisplay('updateLoad');
    }
    toggleDisplay('updateSuccess');
  }).update(getEmail(), getToken());
  toggleDisplay('updateLoad');
}
*/

window.onload = function () {
  // google.script.url.getLocation(function(location) {
  //   alert(location.parameters);
  // });

  var events = ['keypress', 'keydown', 'keyup'];

  events.forEach((e) => { document.getElementById('signInC').addEventListener(e, function(){ checkSignInButton(); }); });
  events.forEach((e) => { document.getElementById('passSignIn').addEventListener(e, function(){ checkPassBox('passSignIn'); checkSignInButton(); }); });
  events.forEach((e) => { document.getElementById('signUpC').addEventListener(e, function(){ checkPassBox('passSignUp'); checkPassBox('passSignUpR'); checkSignUpButton(); }); });
  ['emailSignUp', 'emailSignIn'].forEach((str) => { var elm = document.getElementById(str); events.forEach((e) => { elm.addEventListener(e, function() { checkEmailBox(str); }); }); });

  if (getToken()) {
    toggleDisplay('signInLoad');
    google.script.run.withSuccessHandler(signInSuccess).withFailureHandler(function(e){ if (e.message == 'Bad token.'){ deleteSignInCookies(); }
      if (document.getElementById('signInLoad').style.display == "block") { toggleDisplay('signInLoad'); }
      error('Error when automatically signing in.', e.message)
    }).signInWToken(getEmail(), getToken());
  }

  const signUpForm = document.getElementById("signUpForm");
  signUpForm.addEventListener("submit", signUp);
  const signInForm = document.getElementById('signInForm');
  signInForm.addEventListener('submit', signInF);
}

const firstRow = {
  info: 's',
  class: 'Some Class',
  strt: '',
  end: '',
  b: false,
  days: 'Mon, Wed, Fri',
  name: 'Name'
}
const emptyRow = {
  info: '',
  class: 'Some Class',
  strt: '',
  end: '',
  b: false,
  days: '',
  name: ''
}
function loadSheet() {
  sheet = new Editor({
    el: document.getElementById('testEditor'),
    columns: [
      { header: 'Info', name: 'info', width: 50, editor: { type: 'text', options: { attrs: { maxlength: '2' }, style: { width: '30px' } } } },
      { header: 'Class', name: 'class', width: 200, editor: { type: 'text', options: { style: { width: 'auto' } } } },
      { header: 'Start Time',name: 'strt', width: 100, editor: {type: 'time', options: {format: 'hh:mm A'}} },
      { header: 'End Time',  name: 'end',  width: 100, editor: {type: 'time', options: {format: 'hh:mm A'}} },
      { header: 'Bold', name: 'b', width: 30, editor: { type: 'checkbox', options: { checked: true, style: { "margin-left": "20px" } } } },
      { header: 'Days', name: 'days', width: 200, editor: {
          active: { type: 'col', if: 'info', equalTo: 's' }, 
          type: 'checklist', options: { listItems: [{ text: 'Sun', value: 'Sun' },
            { text: 'Mon', value: 'Mon' }, { text: 'Tue', value: 'Tue' }, { text: 'Wed', value: 'Wed' },
            { text: 'Thu', value: 'Thu' }, { text: 'Fri', value: 'Fri' }, { text: 'Sat', value: 'Sat' }]
          }
        }
      },
      { header: 'Name', name: 'name', width: 200, editor: { active: { type: 'col', if: 'info', equalTo: 's' }, type: 'text', options: { style: { width: '200px' } } } }
    ],
    data: [firstRow, emptyRow, emptyRow]
  })
  const addRowBt = document.getElementById('addRow')
  addRowBt.addEventListener('click', function (ev) { sheet.data.push(emptyRow); sheet.resetData() })
  const rmvRowBt = document.getElementById('removeRow')
  rmvRowBt.addEventListener('click', function (ev) { sheet.data.pop(); sheet.resetData() })
  const saveBt = document.getElementById('saveSch')
  saveBt.addEventListener('click', function (ev) {
    google.script.run.withSuccessHandler(saveSchedulesSuccess).withFailureHandler(saveSchedulesFail).api(
      { email: getEmail(), action: 'edit', token: getToken(), item: 'sch', val: JSON.stringify(sheet.data) })
    document.getElementById('saveSch').innerHTML = '<img id="img" style="width: 25px; top: 0px;" src="https://shortpixel.com/img/spinner2.gif">' 
  })

  google.script.run.withSuccessHandler(getSchedulesSuccess).withFailureHandler(getSchedulesFail).api({ email: getEmail(), action: 'get', token: getToken(), item: 'sch' })
}

/*
function militaryToStandard(time) {
  time = time.split(':'); // convert to array
  var hours = Number(time[0]);
  var minutes = Number(time[1]);
  var timeValue;

  if (hours > 0 && hours <= 12) {
    timeValue = "" + hours;
  } else if (hours > 12) {
    timeValue = "" + (hours - 12);
  } else if (hours == 0) {
    timeValue = "12";
  }

  timeValue += (minutes < 10) ? ":0" + minutes : ":" + minutes;  // get minutes
  timeValue += (hours >= 12) ? " PM" : " AM";  // get AM/PM
  return timeValue
}
*/
function getSchedulesSuccess(response) {
  sheet.data = JSON.parse(response)
  if (sheet.data == []) {
    sheet.data = [firstRow, emptyRow, emptyRow]
  }
  sheet.resetData()
}
function getSchedulesFail(err) {
  alert(err)
  error('error getting schedule for editing', err)
}
function saveSchedulesSuccess(response) {
  document.getElementById('saveSch').innerHTML = 'Save <ion-icon style="top: 15px; color: green; --ionicon-stroke-width: 30px;" class="font-20 bold" name="checkmark"></ion-icon>'
  setTimeout(function() {
    document.getElementById('saveSch').innerHTML = 'Save'
  }, 4000)
}
function saveSchedulesFail(err) {
  document.getElementById('saveSch').innerHTML = 'Save <ion-icon style="top: 15px; color: green; --ionicon-stroke-width: 30px;" class="font-20 bold" name="alert"></ion-icon>'
  setTimeout(function() {
    document.getElementById('saveSch').innerHTML = 'Save'
  }, 4000)
  alert(err)
  error('error saving schedule for editing', err)
}

class Editor {
  constructor(options) {
    this.el = options.el
    this.options = options
    this.columns = options.columns
    this.data = JSON.parse(JSON.stringify(options.data))
    this.rowBack = '#efefef'
    this.headBack = '#ddd'

    this.render('load')
  }
  /**
   * set data of sheet
   * input JSON or nothing
   * if nothing: reload data
  **/
  resetData(data) {
    if (data) {
      this.data = JSON.parse(data)
    } else {
      this.data = JSON.parse(JSON.stringify(this.data))
    }
    this.render()
  }
  // getValueFromEditor(col, row) {
  //   let type = this.columns[col].editor.type
  //   if (type == 'text') {

  //   }
  // }
  createElm(row, col) {
    let coli = this.columns.findIndex((c) => c.name === col)
    let type = this.columns[coli].editor.type
    let data = this.data[row][col]
    let eT

    if (type == 'a' || type == 'text' || type == 'checklist') {
      eT = 'a'
    } else if (type == 'checkbox') {
      eT = 'input'
    }
    let el = document.createElement(eT)

    if (type == 'a' || type == 'text' || type == 'checklist' || type == 'time') {
      el.innerHTML = data
    } else if (type == 'checkbox') {
      el.type = 'checkbox'
      if (data) {
        el.setAttribute('checked', data)
      } else {
        el.removeAttribute('checked')
      }
    }
    return el
  }

  createEditorElm(row, col) {
    let coli = this.columns.findIndex((c) => c.name === col)
    let type = this.columns[coli].editor.type
    let data = this.data[row][col]
    let eTag
    if (type == 'a') {
      eTag = 'a'
    } else if (type == 'checkbox' || type == 'text') {
      eTag = 'input'
    } else if (type == 'checklist' || type == 'time') {
      eTag = 'div'
    }
    let el = document.createElement(eTag)

    if (type == 'text') {     el.value = data
    } else if (type == 'a') { el.innerHTML = data
    } else if (type == 'checkbox') { el.type = 'checkbox'; el.checked = data
    } else if (type == 'checklist') {
      el.classList.add('dropdown-check-list')
      let a = document.createElement('span')
      //a.classList.add('anchor')
      a.setAttribute('onclick', 'sheet.onCellClick(this.parentElement.parentElement, "close")')
      a.style.setProperties({'min-width': '30px', 'min-height': '20px', margin: '-1px'})
      a.innerHTML = this.data[row][col]
      el.append(a)
      let ul = document.createElement('ul')
      ul.style.setProperties({position: 'absolute', background: '#dddddd', 'margin-top': '5px', 'margin-left': '-6px', 'text-align': 'left' })
      ul.classList.add('items')
      let options = this.columns[coli].editor.options.listItems
      for (var op in options) {
        let opt = document.createElement('li')
        let inp = document.createElement('input')
        let txt = document.createElement('a')
        inp.type = 'checkbox'
        if (this.data[row][col].includes(options[op].value)) {
          inp.setAttribute('checked', true)
        }
        txt.innerHTML = options[op].text
        opt.style.setProperties({'list-style-type': 'none', 'margin-left': '-40px'})
        txt.setAttribute('onclick', `this.parentElement.children[0].checked ^= 1`)
        opt.innerHTML = inp.outerHTML + txt.outerHTML
        ul.append(opt)
      }
      el.addEventListener('keypress', function (ev) { if (ev.code == 'Enter') { alert(this); this.blur() } })
      el.append(ul)
      el.setAttribute('customtype', 'checklist')
    } else if (type == 'date') {
      let picker = new TP(el, { initialHour: 8, initialMinute: 0, inputType: 'selectbox', showMeridiem: true })// change 'showMeridiem' to false for 24hr format
      // class TP {
      //   constructor(props) {
      //     var container = document.createElement('div')
      //     var picker = new TimePicker(container, {

      //     })
      //     this.container = container
      //     this.picker = picker
      //     this.timeFormat = props.columnInfo.editor.options.format
      //   }
      //   getElement() { return this.container }
      //   getValue() {
      //     let toReturn
      //     if (this.timeFormat == 'hh:mm A') {
      //       toReturn = militaryToStandard(this.picker.getHour() + ":" + this.picker.getMinute())
      //     } else if (this.timeFormat == 'hh:mm') {
      //       let hr = this.picker.getHour()
      //       let min = String(this.picker.getMinute())
      //       if (min.length == 1) { min = "0" + min }
      //       toReturn = hr + ":" + min
      //     }
      //     return toReturn
      //   }
      //   mounted() { this.el.select(); }
      // }
    }
    let { attrs, style } = this.columns[coli].editor.options
    for (var attr in attrs) {
      el.setAttribute(attr, attrs[attr])
    }
    for (var stl in style) {
      el.style.setProperty(stl, style[stl])
    }
    return el
  }

  render(mod) {
    if (mod == 'load') {this.el.innerHTML = '<center><img id="img" style="width: 50px; top: 100px;" src="https://shortpixel.com/img/spinner2.gif"></center>'; return}
    
    let table = document.createElement('table')
    let header = document.createElement('tr')
    for (var col in this.columns) {
      let el = document.createElement('td')
      el.innerHTML = this.columns[col].header
      el.style.setProperties({margin: '10px', padding: '5px', 'text-align': 'center'})
      header.append(el)
    }
    header.style.setProperties({background: this.headBack, 'font-weight': 'bold'})
    table.style.setProperties({background: '#999', 'font-size': '25px', 'margin-bottom': '200px'})
    table.append(header)

    for (let row in this.data) {
      let rowEl = document.createElement('tr')
      for (let col in this.data[row]) {
        let colEl = document.createElement('td')
        let coli = this.columns.findIndex((c) => c.name === col)
        colEl.setAttribute('row', row)
        colEl.setAttribute('col', col)
        // enable if
        if (this.columns[coli].editor.active) {
          let tru = null
          if (this.columns[coli].editor.active.type == 'col') {
            if (this.columns[coli].editor.active.equalTo) {
              if (this.data[row][this.columns[coli].editor.active.if] == this.columns[coli].editor.active.equalTo) {
                tru = true
              } else { tru = false }
            } else if (this.columns[coli].editor.active.contains) {
              if (this.data[row][this.columns[coli].editor.active.if].includes(this.columns[coli].editor.active.contains)) {
                tru = true
              } else { tru = false }
            } else if (this.columns[coli].editor.active.hasVal) {
              if (this.data[row][this.columns[coli].editor.active.if]) {
                tru = true
              } else { tru = false }
            }
          }
          if (tru) {
            colEl.setAttribute('onclick', 'sheet.onCellClick(this)')
          } else {
            colEl.style.setProperty('background', '#ddd')
            this.data[row][col] = ''
          }
        } else {colEl.setAttribute('onclick', 'sheet.onCellClick(this)')}

        // if (this.columns[coli].name == 'days' || this.columns[coli].name == 'name') {
        //   if (this.data[row]['info'] == 's') {
        //     colEl.setAttribute('onclick', 'sheet.onCellClick(this)')
        //   } else {
        //     colEl.style.setProperty('background', '#ddd')
        //     this.data[row][col] = ''
        //   }
        // } else {
        //   colEl.setAttribute('onclick', 'sheet.onCellClick(this)')
        // }
        // if (this.columns[coli].name == 'class') {
        //   if (this.data[row]['b']) {
        //     colEl.style.setProperty('font-weight', 'bold')
        //   } else {
        //     colEl.style.setProperty('font-weight', 'normal')
        //   }
        // }
        colEl.style.setProperties({padding: '5px', 'text-align': 'center'})

        let el = this.createElm(row, col)
        colEl.append(el)
        rowEl.innerHTML += colEl.outerHTML
      }
      rowEl.style.setProperty('font-size', '25px')
      rowEl.style.setProperty('background', this.rowBack)
      table.append(rowEl)
    }
    this.el.innerHTML = table.outerHTML
    //document.getElementById('datatxt').value = JSON.stringify(this.data)
  }

  onCellClick(el, option) {
    let row = el.getAttribute('row')
    let col = el.getAttribute('col')

    let customtype
    try { customtype = el.innerHTML.match(/(?<=customtype\=\")[a-z]+(?=\")/g)[0] } catch { customtype = null }
    if (el.children[0].type == 'checkbox') {
      if (sheet.data[row][col]) { el.children[0].checked = false } else { el.children[0].checked = true } this.data[row][col] = el.children[0].checked
      this.render()
    } else if (customtype == 'checklist') {
      if (option == 'close') {
        //alert('cloooooooooose')
        let options = this.columns[this.columns.findIndex((c) => c.name === col)].editor.options.listItems
        let dat = ''
        for (var i = 0; i < options.length; i++) {
          //alert(el.children[0].children[1].children[i].children[0].checked)
          if (el.children[0].children[1].children[i].children[0].checked) {
            if (dat) { dat += ", " }
            dat += this.columns[this.columns.findIndex((c) => c.name === col)].editor.options.listItems[i].value
          }
        }
        this.data[row][col] = dat
        el = this.createElm(row, col)
        this.render()
      }
    } else {
      if (el.classList.contains('editMode')) {
        el.classList.remove('editMode')
        el.innerHTML = sheet.createElm(row, col).outerHTML
      } else {
        el.classList.add('editMode')
        el.innerHTML = sheet.createEditorElm(row, col).outerHTML
        if (this.columns[this.columns.findIndex((c) => c.name === col)].editor.type == 'text') {
          let box = el.children[0]
          box.value = sheet.data[row][col]
          box.select()
          box.addEventListener('keypress', function (ev) { if (ev.code == 'Enter') { this.blur() } })
          box.addEventListener('blur', function (ev) {
            ev.preventDefault()
            let row = this.parentElement.getAttribute('row')
            let col = this.parentElement.getAttribute('col')
            sheet.data[row][col] = this.value
            sheet.render()
          })
        }
      }
    }
  }

}
CSSStyleDeclaration.prototype.setProperties = function(properties) {
  for (var property in properties) { this.setProperty(property, properties[property]); }
};
tui.usageStatistics = false
const TP = tui.TimePicker
var l = console.log
var w = console.warn
</script>
